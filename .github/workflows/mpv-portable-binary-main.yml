name: Build MPV with libmpv

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-mpv:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: mpv-build
      BUILD_DIR: build
      INSTALL_DIR: ${{ github.workspace }}/mpv-install

    steps:
    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y \
          build-essential curl tar pkg-config zip \
          git wget patchelf meson ninja-build \
          libavcodec-dev libavformat-dev libavutil-dev \
          libswscale-dev libswresample-dev libavfilter-dev \
          libass-dev \
          libbluray-dev libdvdnav-dev \
          libdvdread-dev libcdio-paranoia-dev \
          libasound2-dev libva-dev libvdpau-dev \
          libx11-dev libxext-dev libxss-dev libxpresent-dev \
          libxrandr-dev libxinerama-dev \
          libegl-dev libgl1-mesa-dev libgles2-mesa-dev \
          libwayland-dev wayland-protocols libxkbcommon-dev \
          liblua5.1-dev libmujs-dev libjpeg-dev libpng-dev \
          libfreetype6-dev libfontconfig-dev \
          liblcms2-dev libuchardet-dev \
          libopenal-dev libsndio-dev \
          libpipewire-0.3-dev libplacebo-dev \
          libarchive-dev \
          mesa-opencl-icd mesa-vulkan-drivers libvulkan-dev \
          python3-dev python3-pip

    - name: Clone mpv source from Git
      run: |
        git clone --depth 1 --branch master https://github.com/mpv-player/mpv.git ${{ env.SOURCE_DIR }}

    - name: Configure build with Meson
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson setup ${{ env.BUILD_DIR }} \
          --prefix=${{ env.INSTALL_DIR }} \
          -Dbuildtype=release \
          -Dlibmpv=true \
          -Dlua=enabled \
          -Djavascript=enabled \
          -Dlibarchive=enabled \
          -Dlibbluray=enabled \
          -Ddvbin=enabled \
          -Ddvdnav=enabled \
          -Dcdda=enabled \
          -Duchardet=enabled \
          -Dlcms2=enabled \
          -Dpulse=disabled \
          -Dalsa=enabled \
          -Dpipewire=enabled \
          -Dvaapi=enabled \
          -Dvdpau=enabled \
          -Dwayland=disabled \
          -Dx11=enabled \
          -Dgl=enabled \
          -Degl=enabled \
          -Dopenal=enabled \
          -Dsndio=enabled \
          -Dvulkan=enabled

    - name: Compile
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson compile -C ${{ env.BUILD_DIR }}

    - name: Install to local directory
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson install -C ${{ env.BUILD_DIR }}

    - name: Bundle shared libraries into installation
      run: |
        mkdir -p ${{ env.INSTALL_DIR }}/lib
        EXCLUDE="libc.so.6 libm.so.6 libpthread.so.0 librt.so.1 libdl.so.2 ld-linux-x86-64.so.2 libutil.so.1 libresolv.so.2 libcrypt.so.1 libcrypt.so.2 libnss_compat.so.2 libnss_dns.so.2 libnss_files.so.2 libnss_nis.so.2 libnss_hesiod.so.2 libanl.so.1 libBrokenLocale.so.1 libthread_db.so.1 libmemusage.so libpcprofile.so libSegFault.so libgcc_s.so.1 libstdc++.so.6 libvulkan.so.1 libva.so.2 libva-drm.so.2 libva-x11.so.2 libva-wayland.so.2 libvdpau.so.1 libGL.so.1 libGLX.so.0 libGLdispatch.so.0 libEGL.so.1 libGLESv2.so.2 libdrm.so.2 libgbm.so.1"
        FILES="${{ env.INSTALL_DIR }}/bin/mpv ${{ env.INSTALL_DIR }}/lib/libmpv.so*"
        for file in $FILES; do
          if [ -f "$file" ]; then
            ldd "$file" 2>/dev/null | grep '=>' | awk '{print $3}' | sort -u | while read lib; do
              if [ -f "$lib" ]; then
                base=$(basename "$lib")
                if echo " $EXCLUDE " | grep -qw " $base "; then
                  echo "Skipping system/core library: $base"
                else
                  cp -Lv --parents --no-clobber "$lib" ${{ env.INSTALL_DIR }}/lib/ || true
                fi
              fi
            done
          fi
        done
        # Recursive pass for dependencies of bundled libraries
        changed=1
        while [ "$changed" = "1" ]; do
          changed=0
          for so in ${{ env.INSTALL_DIR }}/lib/*.so*; do
            if [ -f "$so" ]; then
              ldd "$so" 2>/dev/null | grep '=>' | awk '{print $3}' | sort -u | while read lib; do
                if [ -f "$lib" ]; then
                  base=$(basename "$lib")
                  if echo " $EXCLUDE " | grep -qw " $base "; then
                    echo "Skipping system/core library: $base"
                  else
                    if [ ! -f "${{ env.INSTALL_DIR }}/lib/$base" ]; then
                      cp -Lv --parents --no-clobber "$lib" ${{ env.INSTALL_DIR }}/lib/ || true
                      changed=1
                    fi
                  fi
                fi
              done
            fi
          done
        done

    - name: Create launcher script
      run: |
        mv ${{ env.INSTALL_DIR }}/bin/mpv ${{ env.INSTALL_DIR }}/bin/mpv.bin
        cat << 'EOF' > ${{ env.INSTALL_DIR }}/bin/mpv
        #!/bin/sh
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/../lib${LD_LIBRARY_PATH:+:}${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/mpv.bin" "$@"
        EOF
        chmod +x ${{ env.INSTALL_DIR }}/bin/mpv

    - name: Upload installation artifact
      uses: actions/upload-artifact@v4
      with:
        name: mpv-install
        path: ${{ env.INSTALL_DIR }}
        retention-days: 30
