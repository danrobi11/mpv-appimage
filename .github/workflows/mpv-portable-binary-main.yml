name: Build MPV with libmpv

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-mpv:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: mpv-build
      BUILD_DIR: build
      INSTALL_DIR: ${{ github.workspace }}/mpv-install

    steps:
    - name: Install dependencies
      run:

        sudo apt update -y
        sudo apt install -y \
          build-essential curl tar pkg-config zip \
          git wget patchelf meson ninja-build \
          libavcodec-dev libavformat-dev libavutil-dev \
          libswscale-dev libswresample-dev libavfilter-dev \
          libass-dev  \
          libbluray-dev libdvdnav-dev \
          libdvdread-dev libcdio-paranoia-dev \
          libasound2-dev libva-dev libvdpau-dev \
          libx11-dev libxext-dev libxss-dev libxpresent-dev \
          libxrandr-dev libxinerama-dev \
          libegl-dev libgl1-mesa-dev libgles2-mesa-dev \
          libwayland-dev wayland-protocols libxkbcommon-dev \
          liblua5.1-dev libmujs-dev libjpeg-dev libpng-dev \
          libfreetype6-dev libfontconfig-dev \
          liblcms2-dev libuchardet-dev \
          libopenal-dev libsndio-dev \
          libpipewire-0.3-dev libplacebo-dev \
          libarchive-dev \
          mesa-opencl-icd mesa-vulkan-drivers libvulkan-dev \
          python3-dev python3-pip

    - name: Clone mpv source from Git
      run: |
        git clone --depth 1 --branch master https://github.com/mpv-player/mpv.git ${{ env.SOURCE_DIR }}

    - name: Configure build with Meson
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson setup ${{ env.BUILD_DIR }} \
          --prefix=${{ env.INSTALL_DIR }} \
          -Dbuildtype=release \
          -Dlibmpv=true \
          -Dlua=enabled \
          -Djavascript=enabled \
          -Dlibarchive=enabled \
          -Dlibbluray=enabled \
          -Ddvbin=enabled \
          -Ddvdnav=enabled \
          -Dcdda=enabled \
          -Duchardet=enabled \
          -Dlcms2=enabled \
          -Dpulse=disabled \
          -Dalsa=enabled \
          -Dpipewire=enabled \
          -Dvaapi=enabled \
          -Dvdpau=enabled \
          -Dwayland=disabled \
          -Dx11=enabled \
          -Dgl=enabled \
          -Degl=enabled \
          -Dopenal=enabled \
          -Dsndio=enabled \
          -Dvulkan=enabled

    - name: Compile
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson compile -C ${{ env.BUILD_DIR }}

    - name: Install to local directory
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson install -C ${{ env.BUILD_DIR }}

    - name: Set relative RPATH with patchelf
      run: |
        find ${{ env.INSTALL_DIR }}/bin -type f -executable -exec patchelf --set-rpath '$ORIGIN/../lib' {} \;
        find ${{ env.INSTALL_DIR }}/lib -type f -name '*.so*' -exec patchelf --set-rpath '$ORIGIN' {} \; || true

    - name: Upload installation artifact
      uses: actions/upload-artifact@v4
      with:
        name: mpv-install
        path: ${{ env.INSTALL_DIR }}
        retention-days: 30
