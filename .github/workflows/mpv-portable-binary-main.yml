name: Build MPV with libmpv

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-mpv:
    runs-on: ubuntu-latest
    env:
      SOURCE_DIR: mpv-build
      BUILD_DIR: build
      INSTALL_DIR: ${{ github.workspace }}/mpv-install

    steps:
    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y \
          build-essential curl tar pkg-config zip \
          git wget patchelf meson ninja-build \
          libavcodec-dev libavformat-dev libavutil-dev \
          libswscale-dev libswresample-dev libavfilter-dev \
          libass-dev \
          libbluray-dev libdvdnav-dev \
          libdvdread-dev libcdio-paranoia-dev \
          libasound2-dev libva-dev libvdpau-dev \
          libx11-dev libxext-dev libxss-dev libxpresent-dev \
          libxrandr-dev libxinerama-dev \
          libegl-dev libgl1-mesa-dev libgles2-mesa-dev \
          libwayland-dev wayland-protocols libxkbcommon-dev \
          liblua5.1-dev libmujs-dev libjpeg-dev libpng-dev \
          libfreetype6-dev libfontconfig-dev \
          liblcms2-dev libuchardet-dev \
          libopenal-dev libsndio-dev \
          libpipewire-0.3-dev libplacebo-dev \
          libarchive-dev \
          mesa-opencl-icd mesa-vulkan-drivers libvulkan-dev \
          python3-dev python3-pip

    - name: Clone mpv source from Git
      run: |
        git clone --depth 1 --branch master https://github.com/mpv-player/mpv.git ${{ env.SOURCE_DIR }}

    - name: Configure build with Meson
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson setup ${{ env.BUILD_DIR }} \
          --prefix=${{ env.INSTALL_DIR }} \
          -Dbuildtype=release \
          -Dlibmpv=true \
          -Dlua=enabled \
          -Djavascript=enabled \
          -Dlibarchive=enabled \
          -Dlibbluray=enabled \
          -Ddvbin=enabled \
          -Ddvdnav=enabled \
          -Dcdda=enabled \
          -Duchardet=enabled \
          -Dlcms2=enabled \
          -Dpulse=disabled \
          -Dalsa=enabled \
          -Dpipewire=enabled \
          -Dvaapi=enabled \
          -Dvdpau=enabled \
          -Dwayland=disabled \
          -Dx11=enabled \
          -Dgl=enabled \
          -Degl=enabled \
          -Dopenal=enabled \
          -Dsndio=enabled \
          -Dvulkan=enabled

    - name: Compile
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson compile -C ${{ env.BUILD_DIR }}

    - name: Install to local directory
      run: |
        cd ${{ env.SOURCE_DIR }}
        meson install -C ${{ env.BUILD_DIR }}

    - name: Bundle shared libraries into installation
      run: |
        mkdir -p ${{ env.INSTALL_DIR }}/lib
        # Extensive exclusion list: glibc/core, ALSA, graphics/driver interfaces, audio backends, X11 extensions
        # Added librubberband.so.2 (optional via FFmpeg, often problematic in portable builds)
        EXCLUDE="libc.so libm.so libpthread.so librt.so libdl.so ld-linux-x86-64.so libutil.so libresolv.so libcrypt.so libnss_ libgcc_s.so libstdc++.so libasound.so libopenal.so libpipewire libsndio.so libX11.so libXss.so libXpresent.so libXext.so libXrandr.so libXinerama.so libvulkan.so libva.so libva-drm.so libva-x11.so libva-wayland.so libvdpau.so libGL.so libGLX.so libGLdispatch.so libEGL.so libGLES libdrm.so libgbm.so librubberband.so.2"
        FILES="${{ env.INSTALL_DIR }}/bin/mpv ${{ env.INSTALL_DIR }}/lib/libmpv.so*"
        # Initial pass: dependencies of mpv and libmpv
        for file in $FILES; do
          [ -f "$file" ] || continue
          ldd "$file" | grep '=>' | awk '{print $3}' | sort -u | while read libpath; do
            [ -f "$libpath" ] || continue
            base=$(basename "$libpath")
            if echo "$EXCLUDE" | grep -qw "$base"; then
              echo "Skipping excluded library: $base"
            else
              cp -Lf "$libpath" "${{ env.INSTALL_DIR }}/lib/$base" && chmod 755 "${{ env.INSTALL_DIR }}/lib/$base"
            fi
          done
        done
        # Recursive passes for dependencies of bundled libraries
        changed=1
        while [ "$changed" = "1" ]; do
          changed=0
          for so in ${{ env.INSTALL_DIR }}/lib/*.so*; do
            [ -f "$so" ] || continue
            ldd "$so" | grep '=>' | awk '{print $3}' | sort -u | while read libpath; do
              [ -f "$libpath" ] || continue
              base=$(basename "$libpath")
              if echo "$EXCLUDE" | grep -qw "$base"; then
                echo "Skipping excluded library: $base"
              elif [ ! -f "${{ env.INSTALL_DIR }}/lib/$base" ]; then
                cp -Lf "$libpath" "${{ env.INSTALL_DIR }}/lib/$base" && chmod 755 "${{ env.INSTALL_DIR }}/lib/$base"
                changed=1
              fi
            done
          done
        done

    - name: Remove unnecessary optional dependency (rubberband)
      run: |
        for lib in ${{ env.INSTALL_DIR }}/lib/libavfilter*.so*; do
          [ -f "$lib" ] || continue
          patchelf --remove-needed librubberband.so.2 "$lib"
        done

    - name: Restructure libraries into bin/lib (to avoid ../lib notation)
      run: |
        mv ${{ env.INSTALL_DIR }}/lib ${{ env.INSTALL_DIR }}/bin/lib

    - name: Remove any accidentally bundled conflicting core libraries
      run: |
        rm -fv ${{ env.INSTALL_DIR }}/bin/lib/libc.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libm.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libpthread.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/librt.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libdl.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libutil.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libresolv.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libcrypt.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libnss_* \
               ${{ env.INSTALL_DIR }}/bin/lib/ld-linux-x86-64.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libgcc_s.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libstdc++.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libanl.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libBrokenLocale.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libthread_db.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libmemusage.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libpcprofile.so.* \
               ${{ env.INSTALL_DIR }}/bin/lib/libSegFault.so.*

    - name: Create launcher script
      run: |
        mv ${{ env.INSTALL_DIR }}/bin/mpv ${{ env.INSTALL_DIR }}/bin/mpv.bin
        cat << 'EOF' > ${{ env.INSTALL_DIR }}/bin/mpv
        #!/bin/sh
        SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
        export LD_LIBRARY_PATH="${SCRIPT_DIR}/lib${LD_LIBRARY_PATH:+:}${LD_LIBRARY_PATH}"
        exec "${SCRIPT_DIR}/mpv.bin" "$@"
        EOF
        chmod +x ${{ env.INSTALL_DIR }}/bin/mpv

    - name: Upload installation artifact
      uses: actions/upload-artifact@v4
      with:
        name: mpv-install
        path: ${{ env.INSTALL_DIR }}
        retention-days: 30
